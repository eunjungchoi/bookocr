<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>TypeBook</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="http://twitter.com/favicons/favicon.ico">

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.css">
  </head>
  <body>
    <div class="container">
      <h1 class="title">TypeBook</h1>

      <h2 class="example-name">Type a book name..</h2>

      <div class="row">
        <input class="typebook typeahead" type="text" placeholder="책을 입력하세요.">
      </div>

    <!-- -->
        
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.13.1/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>

    <!--script src="https://apis.google.com/js/client.js?onload=initGoogleApi"></script-->
	<script type="text/javascript">

        function typebook(googleApiKey, $el) {
            //
            // 1. auth with GoogleApiKey
            //

            // insert google api initializer
            //
            //      function initGoogleApi() {
            //          gapi.client.setApiKey(googleApiKey);
            //          gapi.client.load('books', 'v1', function() {
            //              //console.log('load books api');
            //          });
            //      }
            //
            var handlerName = "initGoogleApi_" + Date.now();
            var initScriptEl = document.createElement('script');
            initScriptEl.type = "text/javascript";
            initScriptEl.innerText = [
                "function " + handlerName + "() {",
                    "gapi.client.setApiKey(googleApiKey);",
                    "gapi.client.load('books', 'v1', function() {",
                    '});',
                "}",
            ].join('\n');
            document.getElementsByTagName("script")[0].parentNode.appendChild(initScriptEl);

            // insert google api client script
            var scriptEl = document.createElement('script');
            scriptEl.async = true;
            scriptEl.src = "https://apis.google.com/js/client.js?onload=" + 'initGoogleApi';
            document.getElementsByTagName("script")[0].parentNode.appendChild(scriptEl);

            //
            // 2. bind typeahead
            //

            // build google request bloodhound with GoogleApiKey
            var googleRequestUrl = 'https://content.googleapis.com/books/v1/volumes?key=' + googleApiKey + '&maxResults=20&orderBy=relevance&q=%QUERY';
            var googleBooks = new Bloodhound({
                datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                //prefetch: '../data/films/post_1960.json',
                remote: {
                    url: googleRequestUrl,
                    wildcard: '%QUERY',
                    //prepare: function(query, settings) {
                    //    console.log('prepare:', query, settings);
                    //    return settings;
                    //},
                    transform: transformGoogleApiResult,
                    rateLimitBy: "debounce", // [debounce, throttle]
                    rateLimitWait: 300,
                },
            });

            function transformGoogleApiResult(response) {
                var query  = $typebook.typeahead('val');

                var items0 = response.items;
                    items1 = _.map(items0, function(item, i) {
                        return _.get(item, 'volumeInfo', {});
                    });

                function buildQueryFilter(query) {
                    return function (title) {
                        if (!title) {
                            return false;
                        }

                        // case-insensitive
                        title = title.toLowerCase();
                        query = query.toLowerCase();

                        // whitespace-insensitive
                        title = title.replace(/ /g, '');
                        query = query.replace(/ /g, '');

                        return title.indexOf(query) !== -1;
                    }
                }
                var searchQuery = buildQueryFilter(query);

                // filter
                var items = _.filter(items1, function(volume, i) {
                    if (searchQuery(volume.title    ))  { return true }
                    if (searchQuery(volume.subtitle ))  { return true }
                    if (searchQuery(volume.publisher))  { return true }
                    if (searchQuery((volume.authors||[]).join(' '))) { return true }
                    //console.log(i, 'filter out:', volume.title, query0, volume.title.replace(/ /g, '').indexOf(query0));
                    return false;
                });
                if (response.items.length !== items.length) {
                    console.log('filtered:', items1.length, '=>', items.length);
                }
                //
                var result = _.map(items, function(volume, i) {
                    //console.log(i, volume);
                    var title    = volume.title;
                    var subtitle = volume.subtitle;
                    var authors  = volume.authors || [];
                    var author1  = authors[0];
                    var isbn13 = (_.find(_.get(volume, 'industryIdentifiers', []), function(ident) {
                        return ident.type === "ISBN_13";
                    })||{}).identifier;
                    var isbn10 = (_.find(_.get(volume, 'industryIdentifiers', []), function(ident) {
                        return ident.type === "ISBN_10";
                    })||{}).identifier;
                    var pageCount = volume.pageCount;
                    var categories = volume.categories;
                    var publisher = volume.publisher;
                    var publishedDate = volume.publishedDate;
                    var description = volume.description;
                    var thumbnail = _.get(volume, 'imageLinks.thumbnail');
                    var thumbnailSmall = _.get(volume, 'imageLinks.smallThumbnail');
                    //
                    var previewLink = volume.previewLink;
                    var canonicalVolumeLink = volume.canonicalVolumeLink;

                    //
                    var subtitleStr = '';
                    if (subtitle) {
                        subtitleStr += '- ' + subtitle;
                    }
                    var idStr    = 'typebook-result-item-' + i;
                    var classStr = 'typebook-result-item';

                    //
                    return {
                        idStr: idStr,
                        classStr: classStr,
                        title      : title,
                        subtitle   : subtitle,
                        subtitleStr: subtitleStr,
                        authors  : authors,
                        author1  : author1,
                        authorsStr: authors.join(', '),
                        isbn     : isbn13,
                        publisher: publisher,
                        publishedDate: publishedDate,
                        thumbnail: thumbnailSmall || thumbnail,
                        //
                        previewLink: previewLink,
                        canonicalVolumeLink: canonicalVolumeLink,
                        //
                        //item : item,
                        value: title,
                    };
                });
                return result;
            }


            // typeahead
            //var args = Array.prototype.slice.apply(arguments);
            //args.shift();
            //args.shift();
            //var $typebook = $el.typeahead.apply($el, args);
            var $typebook = $el.typeahead(null, {
                name: 'book',
                source: googleBooks,
                display: 'value',
                hint: true,
                templates: {
                    //notFound: '<div class="empty-message">적당한 책을 찾을 수가 없습니다.</div>',
                    empty: '<div class="empty-message">적당한 책을 찾을 수가 없습니다.</div>',
                    pending: '<div class="pending-message">Searching... <i class="glyphicon glyphicon-refresh"></i></div>',
                    suggestion: Handlebars.compile([
                        "<div href='{{canonicalVolumeLink}}' target='_blank' id='{{idStr}}' class='{{classStr}}'>",
                            "<div class='img-wrapper'>",
                                "<img class='thumbnail' src='{{thumbnail}}' />",
                            "</div>",
                            "<div class='book-info'>",
                                "<div class='first-row'>",
                                    "<span class='book-title'>{{title}}</span>",
                                    ", <span class='book-author'>{{ authorsStr }}</span>",
                                    " <a href='{{canonicalVolumeLink}}' target='_blank' style='display: none;'>바로가기</a>",
                                "</div>",
                                "<div class='second-row'>",
                                    "<span class='book-subtitle' title={{subtitleStr}}>{{subtitleStr}}</span>",
                                "</div>",
                                "<div class='third-row'>",
                                    "<span class='book-publisher'>{{ publisher }}</span>",
                                "</div>",
                            "</div>",
                            "<div class='cleaner'></div>",
                        "</div>"
                    ].join(""))
                }
            });

            $typebook.on('typeahead:select', function(ev, itemObj) {
                var $el   = $('#' + itemObj.idStr);
                var $link = $el.find('a');

                //
                window.open($link.attr('href'), '_blank');
            });

            return $typebook;
        }

    /*
     * typebook
     */
    $(function() {
        var googleApiKey = 'AIzaSyAZBL1esHOeaMG_HRemyBKXm-d-o1Z_x-I';
        var $typebook = typebook(googleApiKey, $('.typebook'));
    });

	</script>

  </body>
</html>
